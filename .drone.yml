---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: 0
  GIT_LFS_SKIP_SMUDGE: 1
kind: pipeline
name: anoma-ci-build-pr
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "432654bb4e5da611d7be4b359c675025aac6f931ca579d916488267f59465d01 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "1f7193a7d75f6ee0b5ad4f067f0974873de6c52942e79d0559b58fb8a140c083 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "5790acb842cd5d1dc0120e4258f30f796de7cd44ac775d836e40eec9a16bea28 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "22083f12f97de4455bc87e00ad5df8ec969e4015f80f696f3c03c3c08b1b4b41 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "19ab6263cc481222b4ecedd1037d2942e4b93d915693aad153bec2a80977ce3d 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "41a66892c2ccecb7295862b724b8523f8673cd3f8b2d14d08dcc755ee5dbcd91 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - make build
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build
    pull: never
  - commands:
      - sccache --start-server
      - make build-test
    depends_on:
      - build
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build-test
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-test
    pull: never
  - commands:
      - >-
        aws s3api head-object --bucket heliax-drone-wasm-v2 --key
        ${DRONE_COMMIT}.json
      - if [ $? -ne 0  ]; then exit 1; fi
      - aws s3 cp s3://heliax-drone-wasm-v2/${DRONE_COMMIT}.json wasm
      - cp wasm/${DRONE_COMMIT}.json wasm/checksums.json
      - >-
        jq -r -c '.[]' wasm/checksums.json | parallel aws s3 cp
        s3://heliax-drone-wasm-v2/{} wasm
    depends_on:
      - build-test
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: download-wasm
    pull: never
  - commands:
      - sccache --start-server
      - make test-unit
    depends_on:
      - download-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-test-unit
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-unit
    pull: never
  - commands:
      - sccache --start-server
      - make test-e2e
    depends_on:
      - download-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-test-e2e
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-e2e
    pull: never
trigger:
  event:
    - pull_request
type: docker
workspace:
  path: /usr/local/rust/project
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-checks-pr
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "432654bb4e5da611d7be4b359c675025aac6f931ca579d916488267f59465d01 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "1f7193a7d75f6ee0b5ad4f067f0974873de6c52942e79d0559b58fb8a140c083 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "5790acb842cd5d1dc0120e4258f30f796de7cd44ac775d836e40eec9a16bea28 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "22083f12f97de4455bc87e00ad5df8ec969e4015f80f696f3c03c3c08b1b4b41 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "19ab6263cc481222b4ecedd1037d2942e4b93d915693aad153bec2a80977ce3d 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "41a66892c2ccecb7295862b724b8523f8673cd3f8b2d14d08dcc755ee5dbcd91 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - make clippy
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-clippy
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: clippy
    pull: never
  - commands:
      - sccache --start-server
      - make fmt-check
    depends_on:
      - check-scripts-integrity
      - clippy
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-format
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: format
    pull: never
trigger:
  branch:
    - develop
    - master
  event:
    - push
    - pull_request
type: docker
workspace:
  path: /usr/local/rust/project
---
clone:
  disable: true
environment:
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-wasm-pr
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "432654bb4e5da611d7be4b359c675025aac6f931ca579d916488267f59465d01 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "1f7193a7d75f6ee0b5ad4f067f0974873de6c52942e79d0559b58fb8a140c083 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "5790acb842cd5d1dc0120e4258f30f796de7cd44ac775d836e40eec9a16bea28 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "22083f12f97de4455bc87e00ad5df8ec969e4015f80f696f3c03c3c08b1b4b41 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "19ab6263cc481222b4ecedd1037d2942e4b93d915693aad153bec2a80977ce3d 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "41a66892c2ccecb7295862b724b8523f8673cd3f8b2d14d08dcc755ee5dbcd91 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
    image: meltwater/drone-cache:latest
    name: restore-cache
    pull: never
    settings:
      archive_format: gzip
      backend: s3
      bucket: heliax-drone-cache-v2
      cache_key: 1-54-0/wasm/{{ checksum "wasm/wasm_source/Cargo.lock" }}
      mount:
        - wasm/wasm_source/target
      region: eu-west-1
      restore: true
  - commands:
      - cp wasm/checksums.json wasm/original-checksums.json
      - make build-wasm-scripts
    depends_on:
      - restore-cache
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: build-wasm
    pull: never
  - commands:
      - >-
        aws s3 sync wasm s3://heliax-drone-wasm-v2 --exclude "*" --exclude "*"
        --include "*.wasm" --exclude "*/*"
      - cp wasm/checksums.json wasm/${DRONE_COMMIT}.json
      - aws s3 cp wasm/${DRONE_COMMIT}.json s3://heliax-drone-wasm-v2
    depends_on:
      - build-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: update-wasm
    pull: never
  - commands:
      - make test-wasm
    depends_on:
      - update-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: test-wasm
    pull: never
  - commands:
      - cmp -- wasm/checksums.json wasm/original-checksums.json
    depends_on:
      - update-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: check-wasm
    pull: never
  - commands:
      - rm -f  ./wasm/wasm_source/target/.rustc_info.json
      - rm -rf ./wasm/wasm_source/target/debug
      - find ./wasm/wasm_source/target/release -maxdepth 1 -type f -delete
      - >-
        find ./wasm/wasm_source/target/wasm32-unknown-unknown -maxdepth 1 -type
        f -delete
    depends_on:
      - test-wasm
      - check-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: clean-cache
    pull: never
    when:
      status:
        - success
        - failure
  - depends_on:
      - clean-cache
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      BACKEND_OPERATION_TIMEOUT: 8m
    image: meltwater/drone-cache:latest
    name: rebuild-cache
    pull: never
    settings:
      archive_format: gzip
      backend: s3
      bucket: heliax-drone-cache-v2
      cache_key: 1-54-0/wasm/{{ checksum "wasm/wasm_source/Cargo.lock" }}
      mount:
        - wasm/wasm_source/target
      override: false
      rebuild: true
      region: eu-west-1
    when:
      status:
        - success
        - failure
trigger:
  event:
    - pull_request
type: docker
workspace:
  path: /usr/local/rust/wasm
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-misc-pr
node:
  project: anoma
steps:
  - commands:
      - git clone $DRONE_GIT_HTTP_URL .
      - git fetch --all
      - git checkout $DRONE_TARGET_BRANCH
      - git merge $DRONE_COMMIT
      - CONFLICTS=$(git ls-files -u | wc -l)
      - if [ "$CONFLICTS" -gt 0 ]; then exit 1; fi;exit 0
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "432654bb4e5da611d7be4b359c675025aac6f931ca579d916488267f59465d01 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "1f7193a7d75f6ee0b5ad4f067f0974873de6c52942e79d0559b58fb8a140c083 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "5790acb842cd5d1dc0120e4258f30f796de7cd44ac775d836e40eec9a16bea28 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "22083f12f97de4455bc87e00ad5df8ec969e4015f80f696f3c03c3c08b1b4b41 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "19ab6263cc481222b4ecedd1037d2942e4b93d915693aad153bec2a80977ce3d 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "41a66892c2ccecb7295862b724b8523f8673cd3f8b2d14d08dcc755ee5dbcd91 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - sh scripts/ci/build-and-publish-docs.sh
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-docs
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-and-publish-docs
    pull: never
trigger:
  event:
    - pull_request
type: docker
workspace:
  path: /usr/local/rust/project
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-cron
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "432654bb4e5da611d7be4b359c675025aac6f931ca579d916488267f59465d01 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "1f7193a7d75f6ee0b5ad4f067f0974873de6c52942e79d0559b58fb8a140c083 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "5790acb842cd5d1dc0120e4258f30f796de7cd44ac775d836e40eec9a16bea28 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "22083f12f97de4455bc87e00ad5df8ec969e4015f80f696f3c03c3c08b1b4b41 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "19ab6263cc481222b4ecedd1037d2942e4b93d915693aad153bec2a80977ce3d 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "41a66892c2ccecb7295862b724b8523f8673cd3f8b2d14d08dcc755ee5dbcd91 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - >-
        curl -sSL
        https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py
        | python3 -
      - source $HOME/.poetry/env
      - cd scripts/ci && poetry install
    depends_on:
      - check-scripts-integrity
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: requirements
    pull: never
  - commands:
      - cargo generate-lockfile
      - cd scripts/ci && poetry run python3 audit.py
    depends_on:
      - requirements
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: audit
    pull: never
  - commands:
      - cd scripts/ci && poetry run python3 udeps.py
    depends_on:
      - requirements
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: udeps
    pull: never
trigger:
  cron:
    - audit
  event:
    - cron
type: docker
workspace:
  path: /usr/local/rust/project
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-miri-master
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "432654bb4e5da611d7be4b359c675025aac6f931ca579d916488267f59465d01 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "1f7193a7d75f6ee0b5ad4f067f0974873de6c52942e79d0559b58fb8a140c083 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "5790acb842cd5d1dc0120e4258f30f796de7cd44ac775d836e40eec9a16bea28 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "22083f12f97de4455bc87e00ad5df8ec969e4015f80f696f3c03c3c08b1b4b41 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "19ab6263cc481222b4ecedd1037d2942e4b93d915693aad153bec2a80977ce3d 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "41a66892c2ccecb7295862b724b8523f8673cd3f8b2d14d08dcc755ee5dbcd91 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - make test-miri || true
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-miri
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-miri
    pull: never
trigger:
  branch:
    - master
  event:
    - push
type: docker
workspace:
  path: /usr/local/rust/project
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-docs-master
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "432654bb4e5da611d7be4b359c675025aac6f931ca579d916488267f59465d01 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "1f7193a7d75f6ee0b5ad4f067f0974873de6c52942e79d0559b58fb8a140c083 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "5790acb842cd5d1dc0120e4258f30f796de7cd44ac775d836e40eec9a16bea28 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "22083f12f97de4455bc87e00ad5df8ec969e4015f80f696f3c03c3c08b1b4b41 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "19ab6263cc481222b4ecedd1037d2942e4b93d915693aad153bec2a80977ce3d 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "41a66892c2ccecb7295862b724b8523f8673cd3f8b2d14d08dcc755ee5dbcd91 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - sh scripts/ci/build-and-publish-docs.sh
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-docs
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-and-publish-docs
    pull: never
trigger:
  branch:
    - master
  event:
    - push
type: docker
workspace:
  path: /usr/local/rust/project
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-build-master
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "432654bb4e5da611d7be4b359c675025aac6f931ca579d916488267f59465d01 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "1f7193a7d75f6ee0b5ad4f067f0974873de6c52942e79d0559b58fb8a140c083 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "5790acb842cd5d1dc0120e4258f30f796de7cd44ac775d836e40eec9a16bea28 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "22083f12f97de4455bc87e00ad5df8ec969e4015f80f696f3c03c3c08b1b4b41 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "19ab6263cc481222b4ecedd1037d2942e4b93d915693aad153bec2a80977ce3d 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "41a66892c2ccecb7295862b724b8523f8673cd3f8b2d14d08dcc755ee5dbcd91 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - make build
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build
    pull: never
  - commands:
      - sccache --start-server
      - make build-test
    depends_on:
      - build
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build-test
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-test
    pull: never
  - commands:
      - >-
        aws s3api head-object --bucket heliax-drone-wasm-v2 --key
        ${DRONE_COMMIT}.json
      - if [ $? -ne 0  ]; then exit 1; fi
      - aws s3 cp s3://heliax-drone-wasm-v2/${DRONE_COMMIT}.json wasm
      - cp wasm/${DRONE_COMMIT}.json wasm/checksums.json
      - >-
        jq -r -c '.[]' wasm/checksums.json | parallel aws s3 cp
        s3://heliax-drone-wasm-v2/{} wasm
    depends_on:
      - build-test
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: download-wasm
    pull: never
  - commands:
      - sccache --start-server
      - make test-unit
    depends_on:
      - download-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-test-unit
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-unit
    pull: never
  - commands:
      - sccache --start-server
      - make test-e2e
    depends_on:
      - download-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-test-e2e
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-e2e
    pull: never
trigger:
  branch:
    - master
  event:
    - push
type: docker
workspace:
  path: /usr/local/rust/project
---
clone:
  disable: true
environment:
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-wasm-master
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "432654bb4e5da611d7be4b359c675025aac6f931ca579d916488267f59465d01 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "1f7193a7d75f6ee0b5ad4f067f0974873de6c52942e79d0559b58fb8a140c083 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "5790acb842cd5d1dc0120e4258f30f796de7cd44ac775d836e40eec9a16bea28 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "22083f12f97de4455bc87e00ad5df8ec969e4015f80f696f3c03c3c08b1b4b41 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "19ab6263cc481222b4ecedd1037d2942e4b93d915693aad153bec2a80977ce3d 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "41a66892c2ccecb7295862b724b8523f8673cd3f8b2d14d08dcc755ee5dbcd91 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
    image: meltwater/drone-cache:latest
    name: restore-cache
    pull: never
    settings:
      archive_format: gzip
      backend: s3
      bucket: heliax-drone-cache-v2
      cache_key: 1-54-0/wasm/{{ checksum "wasm/wasm_source/Cargo.lock" }}
      mount:
        - wasm/wasm_source/target
      region: eu-west-1
      restore: true
  - commands:
      - cp wasm/checksums.json wasm/original-checksums.json
      - make build-wasm-scripts
    depends_on:
      - restore-cache
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: build-wasm
    pull: never
  - commands:
      - >-
        aws s3 sync wasm s3://heliax-drone-wasm-v2 --exclude "*" --exclude "*"
        --include "*.wasm" --exclude "*/*"
      - cp wasm/checksums.json wasm/${DRONE_COMMIT}.json
      - aws s3 cp wasm/${DRONE_COMMIT}.json s3://heliax-drone-wasm-v2
    depends_on:
      - build-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: update-wasm
    pull: never
  - commands:
      - make test-wasm
    depends_on:
      - update-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: test-wasm
    pull: never
  - commands:
      - cmp -- wasm/checksums.json wasm/original-checksums.json
    depends_on:
      - update-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: check-wasm
    pull: never
  - commands:
      - >-
        aws s3 sync wasm s3://heliax-anoma-wasm-v1 --acl public-read --exclude
        "*" --exclude "*" --include "*.wasm" --exclude "*/*"
      - cp wasm/checksums.json wasm/${DRONE_COMMIT}.json
      - >-
        aws s3 cp wasm/${DRONE_COMMIT}.json s3://heliax-anoma-wasm-v1 --acl
        public-read
    depends_on:
      - test-wasm
      - check-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: upload-wasm
    pull: never
  - commands:
      - rm -f  ./wasm/wasm_source/target/.rustc_info.json
      - rm -rf ./wasm/wasm_source/target/debug
      - find ./wasm/wasm_source/target/release -maxdepth 1 -type f -delete
      - >-
        find ./wasm/wasm_source/target/wasm32-unknown-unknown -maxdepth 1 -type
        f -delete
    depends_on:
      - test-wasm
      - check-wasm
      - upload-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: clean-cache
    pull: never
    when:
      status:
        - success
        - failure
  - depends_on:
      - clean-cache
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      BACKEND_OPERATION_TIMEOUT: 8m
    image: meltwater/drone-cache:latest
    name: rebuild-cache
    pull: never
    settings:
      archive_format: gzip
      backend: s3
      bucket: heliax-drone-cache-v2
      cache_key: 1-54-0/wasm/{{ checksum "wasm/wasm_source/Cargo.lock" }}
      mount:
        - wasm/wasm_source/target
      override: false
      rebuild: true
      region: eu-west-1
    when:
      status:
        - success
        - failure
trigger:
  branch:
    - master
  event:
    - push
type: docker
workspace:
  path: /usr/local/rust/wasm
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-release
node:
  project: anoma
steps:
  - commands:
      - git clone $DRONE_GIT_HTTP_URL .
      - git fetch --all
      - git checkout $DRONE_TARGET_BRANCH
      - git merge $DRONE_COMMIT
      - CONFLICTS=$(git ls-files -u | wc -l)
      - if [ "$CONFLICTS" -gt 0 ]; then exit 1; fi;exit 0
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "432654bb4e5da611d7be4b359c675025aac6f931ca579d916488267f59465d01 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "1f7193a7d75f6ee0b5ad4f067f0974873de6c52942e79d0559b58fb8a140c083 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "5790acb842cd5d1dc0120e4258f30f796de7cd44ac775d836e40eec9a16bea28 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "22083f12f97de4455bc87e00ad5df8ec969e4015f80f696f3c03c3c08b1b4b41 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "19ab6263cc481222b4ecedd1037d2942e4b93d915693aad153bec2a80977ce3d 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "41a66892c2ccecb7295862b724b8523f8673cd3f8b2d14d08dcc755ee5dbcd91 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - sh scripts/ci/build-and-publish-docs.sh
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-docs
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-and-publish-docs
    pull: never
  - commands:
      - sccache --start-server
      - make package
    depends_on:
      - build-and-publish-docs
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build-release
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:release
    name: build-package
    pull: never
  - commands:
      - sh scripts/ci/release.sh
    depends_on:
      - build-package
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: create-release
    pull: never
trigger:
  event:
    - tag
type: docker
workspace:
  path: /usr/local/rust/project
---
kind: signature
hmac: acd003dd0f1c8046c70f2e3ed094c20221ff6330b2b71efe4a325c540d6bc886

...
